package com.example.androidmalwaredetector;

import androidx.appcompat.app.AppCompatActivity;

import android.content.Context;
import android.content.pm.PackageInfo;
import android.content.pm.PackageManager;
import android.graphics.drawable.Drawable;
import android.os.Bundle;
import android.util.Log;
import android.widget.ImageView;
import android.widget.TextView;
import android.widget.Toast;

import com.example.androidmalwaredetector.utilities.ManifestParser;
import com.example.androidmalwaredetector.utilities.Utils;
import com.example.androidmalwaredetector.utilities.classifier;
import com.example.androidmalwaredetector.utilities.features;
import com.example.androidmalwaredetector.utilities.universalParser;

import net.dongliu.apk.parser.ApkFile;
import net.dongliu.apk.parser.bean.ApkMeta;
import net.dongliu.apk.parser.bean.UseFeature;

import java.io.File;
import java.io.IOException;
import java.util.List;

import de.hdodenhof.circleimageview.CircleImageView;


import org.jf.dexlib2.DexFileFactory;
import org.jf.dexlib2.Opcodes;
import org.jf.dexlib2.ReferenceType;
import org.jf.dexlib2.iface.ClassDef;
import org.jf.dexlib2.iface.DexFile;
import org.jf.dexlib2.iface.Method;
import org.jf.dexlib2.iface.MethodImplementation;
import org.jf.dexlib2.iface.instruction.Instruction;
import org.jf.dexlib2.iface.instruction.ReferenceInstruction;
import org.jf.dexlib2.iface.reference.MethodReference;

public class singleApkAnalysis extends AppCompatActivity {

    int malProb;
    String location;
    String mlAlgo;
    String TAG = "SingleAPK";
    ImageView iconImg;
    TextView permissionsView, featuresView, actionView, serviceView, receiverView, appName, pkgName, isMalware;
    CircleImageView malIndicator;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_single_apk_analysis);
        location = getIntent().getStringExtra("apkLocation");
        mlAlgo = getIntent().getStringExtra("mlAlgo");

        malIndicator = findViewById(R.id.S_circleIndi);
        iconImg = findViewById(R.id.S_icon);
        permissionsView = findViewById(R.id.S_permissions);
        actionView = findViewById(R.id.S_action);
        serviceView = findViewById(R.id.S_service);
        receiverView = findViewById(R.id.S_receiver);
        featuresView = findViewById(R.id.S_features);
        isMalware = findViewById(R.id.S_malwareProb);
        appName = findViewById(R.id.S_appName);
        pkgName = findViewById(R.id.S_pkgName);

        appName.setTextSize(20);

        Long start = System.currentTimeMillis();
        String manifest = Utils.getManifest(location);
        ManifestParser manifestParser = new ManifestParser(manifest, 0);
        //List<Integer> inputArray = manifestParser.getInputArray();
        //List<String> apiCalls = universalParser.getApiCalls(location);
        List<String> apiCalls = universalParser.getAttributes(manifest, "permissions");
        Log.d("SingleAPKAnalysis", String.valueOf(apiCalls));
        features f = new features();
        for(String i : apiCalls)
            f.add(i);
        List<Integer> inputArray = f.getPermList();
        Log.d("SingleAPKAnalysis", String.valueOf(inputArray));
        classifier c = new classifier();
        malProb = 100 - c.classify(inputArray, mlAlgo,this);
        Long end = System.currentTimeMillis();
        long elapsedTime = end - start;
        isMalware.setText("Malware Probability: " + malProb + "/100");
        iconImg.setImageDrawable(getIcon(location, this));


        if(malProb <= 50){
            malIndicator.setImageResource(R.color.safe);
        }
        else if(malProb <= 75){
            malIndicator.setImageResource(R.color.suspicious);
        }
        else{
            malIndicator.setImageResource(R.color.danger);
        }

        try (ApkFile apkFile = new ApkFile(new File(location))) {
            ApkMeta apkMeta = apkFile.getApkMeta();
            pkgName.setText(apkMeta.getPackageName());
            appName.setText(apkMeta.getName());
        } catch (IOException e) {
            e.printStackTrace();
        }
        permissionsView.setText(manifestParser.getPermissionSet());
        serviceView.setText(manifestParser.getServiceSet());
        actionView.setText(manifestParser.getActionSet());
        featuresView.setText(manifestParser.getFeatureSet());
        receiverView.setText(manifestParser.getReceiverSet());

        getApiCalls(location);
    }

    void getApiCalls(String location){

        DexFile dexFile = null ;
        try{
            dexFile = DexFileFactory.loadDexFile(location
                    , Opcodes.getDefault());

        }catch (IOException ioe){
            ioe.printStackTrace();
        }
        if (dexFile != null){
           printMethodInvocations(dexFile);
        }else
        {
            Log.d("getApiCalls", "onCreate: dex file is null");
        }

    }

    public void printMethodInvocations(DexFile dexFile) {
        for (ClassDef classDef: dexFile.getClasses()) {
            for (Method methodDef: classDef.getMethods()) {
                MethodImplementation methodImpl = methodDef.getImplementation();

                if (methodImpl != null) {
                    for (Instruction instruction: methodImpl.getInstructions()) {
                        if (instruction instanceof ReferenceInstruction) {
                            if (((ReferenceInstruction)instruction).getReferenceType() == ReferenceType.METHOD) {
                                MethodReference methodReference =
                                        (MethodReference) ((ReferenceInstruction)instruction).getReference();
                                Log.d("getApiCalls", String.format("found invocation of method: %s", methodReference));

                            }
                        }
                    }
                }
            }
        }
    }

    static Drawable getIcon(String location, Context context){
        PackageManager pm = context.getApplicationContext().getPackageManager();
        PackageInfo pi = pm.getPackageArchiveInfo(location, 0);
        pi.applicationInfo.sourceDir       = location;
        pi.applicationInfo.publicSourceDir = location;
        return pi.applicationInfo.loadIcon(pm);
    }
}