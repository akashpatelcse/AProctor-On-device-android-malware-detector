package com.example.androidmalwaredetector;

import androidx.appcompat.app.AppCompatActivity;

import android.content.Context;
import android.content.pm.PackageInfo;
import android.content.pm.PackageManager;
import android.graphics.drawable.Drawable;
import android.os.Bundle;
import android.util.Log;
import android.widget.ImageView;
import android.widget.TextView;
import android.widget.Toast;

import com.example.androidmalwaredetector.utilities.ManifestParser;
import com.example.androidmalwaredetector.utilities.Utils;
import com.example.androidmalwaredetector.utilities.classifier;

import net.dongliu.apk.parser.ApkFile;
import net.dongliu.apk.parser.bean.ApkMeta;
import net.dongliu.apk.parser.bean.UseFeature;

import java.io.File;
import java.io.IOException;
import java.util.List;

public class singleApkAnalysis extends AppCompatActivity {

    int goodProb, badProb;
    String location;
    String mlAlgo;
    String TAG = "SingleAPK";
    ImageView iconImg;
    TextView permissionsView, featuresView, appName, pkgName, isMalware;


    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_single_apk_analysis);
        location = getIntent().getStringExtra("apkLocation");
        mlAlgo = getIntent().getStringExtra("mlAlgo");

        iconImg = findViewById(R.id.S_icon);
        permissionsView = findViewById(R.id.S_permissions);
        featuresView = findViewById(R.id.S_features);
        isMalware = findViewById(R.id.S_isMalware);
        appName = findViewById(R.id.S_appName);
        pkgName = findViewById(R.id.S_pkgName);

        Long start = System.currentTimeMillis();
        String manifest = Utils.getManifest(location);
        ManifestParser manifestParser = new ManifestParser(manifest);
        List<Integer> inputArray = manifestParser.getInputArray();
        classifier c = new classifier();
        goodProb = c.classify(inputArray, mlAlgo,this);
        Long end = System.currentTimeMillis();
        long elapsedTime = end - start;
        isMalware.setText("GoodProb: " + goodProb);
        iconImg.setImageDrawable(getIcon(location, this));
        //iconImg.setImageIcon(getIcon(location, this));
        try (ApkFile apkFile = new ApkFile(new File(location))) {
            ApkMeta apkMeta = apkFile.getApkMeta();
            Log.d(TAG,apkMeta.getLabel());
            Log.d(TAG,apkMeta.getPackageName());
            pkgName.setText(apkMeta.getPackageName());
            appName.setText(apkMeta.getName());
            Toast.makeText(this, apkMeta.getPackageName(), Toast.LENGTH_SHORT).show();
            for (UseFeature feature : apkMeta.getUsesFeatures()) {
                Log.d(TAG, feature.getName());
            }
        } catch (IOException e) {
            Log.d(TAG,e.toString());
            e.printStackTrace();
        }

    }

    static Drawable getIcon(String location, Context context){
        PackageManager pm = context.getApplicationContext().getPackageManager();
        PackageInfo pi = pm.getPackageArchiveInfo(location, 0);

        pi.applicationInfo.sourceDir       = location;
        pi.applicationInfo.publicSourceDir = location;

        Drawable APKicon = pi.applicationInfo.loadIcon(pm);
        String   AppName = (String)pi.applicationInfo.loadLabel(pm);
        return APKicon;
    }
}